---
- hosts: us-west-2
  become: yes
  become_method: sudo

  environment:
      DEBUG: '{{ DEBUG }}'
      SECRET_KEY: '{{ SECRET_KEY }}'
      DATABASE_NAME: '{{ DATABASE_NAME }}'
      DATABASE_USER: '{{ DATABASE_USER }}'
      DATABASE_PASSWORD: '{{ DATABASE_PASSWORD }}'
      DATABASE_HOST: '{{ DATABASE_HOST }}'
      AWS_ACCESS_KEY_ID: '{{ AWS_ACCESS_KEY_ID }}'
      AWS_SECRET_ACCESS_KEY: '{{ AWS_SECRET_ACCESS_KEY }}'
      AWS_STORAGE_BUCKET_NAME: '{{ AWS_STORAGE_BUCKET_NAME }}'

  tasks:
    - name: Update things on instance of ec2
      apt: update_cache=yes
      become_method: sudo
    - name: Install nginx, git, python3, python3-pip, python3.4-venv
      apt: name={{ item }} state=latest
      with_items:
        - libpq-dev
        - nginx
        - git
        - python3
        - python3-pip
        - python3.4-venv
        - python-dev
    - name: Clone things from git
      git:
        clone=yes
        repo=https://github.com/nosrac77/portfolio.git
        dest=/home/ubuntu/portfolio/
        version=features-customize-template
    - name: Create venv
      command: python3 -m venv /home/ubuntu/portfolio/ENV
    - name: Install gunicorn to VENV
      pip:
        virtualenv=/home/ubuntu/portfolio/ENV
        name={{ item }}
      with_items:
        - gunicorn
    - name: Register old default
      stat: path=/etc/nginx/sites-available/default.old
      register: default_stat
    - name: Rename old default file
      command: mv /etc/nginx/sites-available/default /etc/nginx/sites-available/default.pip
      when: not default_stat.stat.exists
    - name: Create new default file for nginx
      template:
        src=/home/nosrac/personal_projects/portfolio/simple_nginx_config
        dest=/etc/nginx/sites-available/default
    - name: Restart the nginx service
      service:
        name=nginx
        state=restarted
      become: yes
      become_method: sudo
    - name: Copy upstart script into etc
      template:
        src=/home/nosrac/personal_projects/portfolio/gunicorn.conf
        dest=/etc/init/
    - pip:
        virtualenv: /home/ubuntu/portfolio/ENV
        requirements: /home/ubuntu/portfolio/requirements.pip
    - django_manage:
        virtualenv: /home/ubuntu/portfolio/ENV
        command: collectstatic
        app_path: /home/ubuntu/portfolio/portfolio/
    - name: Start Portfolio Website app
      service:
        name=gunicorn
        state=restarted
      become: yes
      become_method: sudo
